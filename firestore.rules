rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isValidUserDoc() {
      let data = request.resource.data;
      return data.keys().hasAll(['id', 'displayName', 'emoji', 'color', 'isAnonymous', 'createdBoards', 'createdAt', 'updatedAt'])
        && data.id is string
        && data.id == request.auth.uid
        && data.displayName is string
        && data.displayName.size() >= 1
        && data.displayName.size() <= 120
        && data.emoji is string
        && data.emoji.size() >= 1
        && data.emoji.size() <= 16
        && data.color is string
        && data.color.size() >= 1
        && data.color.size() <= 32
        && data.isAnonymous is bool
        && data.createdBoards is list
        && data.createdBoards.size() <= 2000
        && data.createdAt is number
        && data.updatedAt is number
        && data.updatedAt >= data.createdAt
        && (data.get('email', null) == null || (data.email is string && data.email.size() <= 320));
    }

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isValidUserDoc();
      allow update: if isOwner(userId) && isValidUserDoc();
      allow delete: if isOwner(userId);
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
