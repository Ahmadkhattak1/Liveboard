{
  "rules": {
    ".read": false,
    ".write": false,

    "boards": {
      "$boardId": {
        ".read": "auth != null && (data.child('metadata/createdBy').val() === auth.uid || (data.child('metadata/isPublic').val() === true && auth.token.firebase.sign_in_provider !== 'anonymous'))",

        ".write": "auth != null && ((!data.exists() && newData.child('metadata/createdBy').val() === auth.uid) || (data.exists() && data.child('metadata/createdBy').val() === auth.uid))",

        "metadata": {
          ".validate": "newData.hasChildren(['id', 'createdBy', 'createdAt', 'updatedAt', 'isPublic'])",

          "id": {
            ".validate": "newData.isString() && newData.val() === $boardId && newData.val().length > 0 && newData.val().length <= 50"
          },
          "title": {
            ".validate": "newData.isString() && newData.val().length <= 200"
          },
          "emoji": {
            ".validate": "newData.isString() && newData.val().length <= 16"
          },
          "createdBy": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 128"
          },
          "createdAt": {
            ".validate": "newData.isNumber()"
          },
          "updatedAt": {
            ".write": "auth != null && auth.token.firebase.sign_in_provider !== 'anonymous' && root.child('boards').child($boardId).child('metadata').child('isPublic').val() === true",
            ".validate": "newData.isNumber()"
          },
          "isPublic": {
            ".validate": "newData.isBoolean()"
          },
          "shareCode": {
            ".validate": "newData.isString() && newData.val().matches(/^[23456789ABCDEFGHJKLMNPQRSTUVWXYZ]{8}$/)"
          },
          "allowSharedEditing": {
            ".validate": "newData.isBoolean()"
          },
          "$other": {
            ".validate": false
          }
        },

        "canvas": {
          ".write": "auth != null && auth.token.firebase.sign_in_provider !== 'anonymous' && root.child('boards').child($boardId).child('metadata').child('isPublic').val() === true && root.child('boards').child($boardId).child('metadata').child('allowSharedEditing').val() !== false",
          ".validate": "newData.hasChild('version')",

          "version": {
            ".validate": "newData.isString()"
          },
          "objects": {
            ".validate": true
          },
          "background": {
            ".validate": "newData.isString() && newData.val().length <= 100"
          },
          "updatedAt": {
            ".validate": "newData.isNumber()"
          },
          "updatedBy": {
            ".validate": "newData.isString() && newData.val().length <= 128"
          },
          "objectCount": {
            ".validate": "newData.isNumber() && newData.val() <= 10000"
          }
        },

        "presence": {
          "$presenceId": {
            ".write": "auth != null && ((newData.exists() && newData.child('userId').val() === auth.uid) || (!newData.exists() && data.child('userId').val() === auth.uid))",
            ".validate": "newData.hasChildren(['userId', 'displayName', 'color', 'emoji', 'cursor', 'lastSeen', 'isActive'])",

            "userId": {
              ".validate": "newData.isString() && newData.val() === auth.uid"
            },
            "sessionId": {
              ".validate": "newData.isString() && newData.val().length <= 100"
            },
            "displayName": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 120"
            },
            "color": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 32"
            },
            "emoji": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 16"
            },
            "cursor": {
              ".validate": "newData.hasChildren(['x', 'y'])",
              "x": { ".validate": "newData.isNumber()" },
              "y": { ".validate": "newData.isNumber()" },
              "$other": { ".validate": false }
            },
            "lastSeen": {
              ".validate": "newData.isNumber()"
            },
            "isActive": {
              ".validate": "newData.isBoolean()"
            },
            "activity": {
              "tool": { ".validate": "newData.isString() && newData.val().length <= 50" },
              "isDrawing": { ".validate": "newData.isBoolean()" },
              "trail": { ".validate": true },
              "updatedAt": { ".validate": "newData.isNumber()" }
            },
            "$other": { ".validate": false }
          }
        },

        "$other": { ".validate": false }
      }
    },

    "shareCodes": {
      "$code": {
        ".read": "auth != null && auth.token.firebase.sign_in_provider !== 'anonymous'",
        ".write": "auth != null && auth.token.firebase.sign_in_provider !== 'anonymous' && ((newData.exists() && root.child('boards').child(newData.val()).child('metadata').child('createdBy').val() === auth.uid) || (!newData.exists() && root.child('boards').child(data.val()).child('metadata').child('createdBy').val() === auth.uid))",
        ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
      }
    },

    "users": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null && auth.uid === $userId",
        ".validate": "newData.hasChildren(['id', 'displayName', 'emoji', 'color', 'isAnonymous', 'createdBoards', 'createdAt', 'updatedAt'])",

        "id": {
          ".validate": "newData.isString() && newData.val() === $userId"
        },
        "email": {
          ".validate": "newData.isString() && newData.val().length <= 320"
        },
        "displayName": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 120"
        },
        "emoji": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 16"
        },
        "color": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 32"
        },
        "isAnonymous": {
          ".validate": "newData.isBoolean()"
        },
        "createdBoards": {
          ".validate": true
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        "updatedAt": {
          ".validate": "newData.isNumber()"
        },
        "$other": {
          ".validate": false
        }
      }
    }
  }
}
